name: Auto Release (VERSION + CHANGELOG)

on:
  push:
    branches: ["main"]
    paths:
      - "VERSION"
      - "CHANGELOG.md"

permissions:
  contents: write # tag + release için gerekli

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # tag kontrolü için gerekli

      - name: Read VERSION
        id: ver
        shell: bash
        run: |
          if [ ! -f VERSION ]; then
            echo "VERSION file not found"; exit 1
          fi
          VERSION="$(cat VERSION | tr -d ' \t\r\n')"
          if [ -z "$VERSION" ]; then
            echo "VERSION is empty"; exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"

      - name: Check if tag already exists
        id: tagcheck
        shell: bash
        run: |
          git fetch --tags --force
          TAG="${{ steps.ver.outputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract release notes from CHANGELOG
        id: notes
        if: steps.tagcheck.outputs.exists == 'false'
        shell: bash
        run: |
          VERSION="${{ steps.ver.outputs.version }}"

          if [ ! -f CHANGELOG.md ]; then
            echo "CHANGELOG.md not found"; exit 1
          fi

          # CHANGELOG format:
          # ## [1.9.4] – Title
          # ... lines ...
          # ## [1.9.3] – Title
          #
          # We extract lines between the target header and the next header.
          awk -v ver="$VERSION" '
            BEGIN { found=0 }
            $0 ~ "^## \\[" ver "\\]" { found=1; next }
            $0 ~ "^## \\[" && found==1 { exit }
            found==1 { print }
          ' CHANGELOG.md > RELEASE_NOTES.txt

          # Eğer boşsa fail (changelog'a ilgili sürüm eklenmemiş demektir)
          if [ ! -s RELEASE_NOTES.txt ]; then
            echo "No CHANGELOG section found for version $VERSION (expected header: ## [$VERSION])"
            exit 1
          fi

          echo "path=RELEASE_NOTES.txt" >> "$GITHUB_OUTPUT"

      - name: Create tag
        if: steps.tagcheck.outputs.exists == 'false'
        shell: bash
        run: |
          TAG="${{ steps.ver.outputs.tag }}"
          git tag "$TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        if: steps.tagcheck.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          body_path: ${{ steps.notes.outputs.path }}
          draft: false
          prerelease: false
